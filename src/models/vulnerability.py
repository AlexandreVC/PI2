"""Vulnerability data model."""

from dataclasses import dataclass, field
from enum import Enum
from typing import Optional, List
from datetime import datetime


class VulnerabilitySeverity(Enum):
    """Severity levels based on CVSS scores."""
    CRITICAL = "critical"  # 9.0 - 10.0
    HIGH = "high"          # 7.0 - 8.9
    MEDIUM = "medium"      # 4.0 - 6.9
    LOW = "low"            # 0.1 - 3.9
    INFO = "info"          # 0.0

    @classmethod
    def from_cvss(cls, score: float) -> "VulnerabilitySeverity":
        """Convert CVSS score to severity level."""
        if score >= 9.0:
            return cls.CRITICAL
        elif score >= 7.0:
            return cls.HIGH
        elif score >= 4.0:
            return cls.MEDIUM
        elif score > 0:
            return cls.LOW
        return cls.INFO


@dataclass
class Vulnerability:
    """Represents a security vulnerability."""

    # Core identification
    id: str  # Internal ID
    cve_id: Optional[str] = None  # CVE identifier (e.g., CVE-2021-44228)

    # Description
    title: str = ""
    description: str = ""

    # Severity assessment
    cvss_score: float = 0.0
    cvss_vector: str = ""
    severity: VulnerabilitySeverity = VulnerabilitySeverity.INFO

    # Context
    affected_host: str = ""
    affected_port: int = 0
    affected_service: str = ""
    affected_product: str = ""
    affected_version: str = ""

    # Enrichment data
    cwe_id: Optional[str] = None  # Common Weakness Enumeration
    exploitability: str = ""  # Ease of exploitation
    exploit_available: bool = False
    patch_available: bool = False

    # Remediation
    remediation: str = ""
    remediation_priority: int = 0  # 1 = highest priority

    # Code analysis (for code vulnerabilities)
    vulnerable_code: str = ""  # The problematic code snippet
    fixed_code: str = ""  # The corrected code example
    affected_file: str = ""  # File path where vulnerability was found
    location: str = ""  # Line number or location in file

    # MITRE ATT&CK mapping
    mitre_tactics: List[str] = field(default_factory=list)
    mitre_techniques: List[str] = field(default_factory=list)

    # Metadata
    source: str = ""  # nmap, nessus, openvas, manual
    discovered_at: datetime = field(default_factory=datetime.now)
    references: List[str] = field(default_factory=list)

    # AI analysis
    ai_analysis: str = ""
    ai_risk_assessment: str = ""
    ai_business_impact: str = ""

    def __post_init__(self):
        """Auto-compute severity from CVSS if not set."""
        if self.cvss_score > 0 and self.severity == VulnerabilitySeverity.INFO:
            self.severity = VulnerabilitySeverity.from_cvss(self.cvss_score)

    def to_dict(self) -> dict:
        """Convert to dictionary for serialization."""
        return {
            "id": self.id,
            "cve_id": self.cve_id,
            "title": self.title,
            "description": self.description,
            "cvss_score": self.cvss_score,
            "cvss_vector": self.cvss_vector,
            "severity": self.severity.value,
            "affected_host": self.affected_host,
            "affected_port": self.affected_port,
            "affected_service": self.affected_service,
            "affected_product": self.affected_product,
            "affected_version": self.affected_version,
            "cwe_id": self.cwe_id,
            "exploitability": self.exploitability,
            "exploit_available": self.exploit_available,
            "patch_available": self.patch_available,
            "remediation": self.remediation,
            "remediation_priority": self.remediation_priority,
            "vulnerable_code": self.vulnerable_code,
            "fixed_code": self.fixed_code,
            "affected_file": self.affected_file,
            "location": self.location,
            "mitre_tactics": self.mitre_tactics,
            "mitre_techniques": self.mitre_techniques,
            "source": self.source,
            "discovered_at": self.discovered_at.isoformat(),
            "references": self.references,
            "ai_analysis": self.ai_analysis,
            "ai_risk_assessment": self.ai_risk_assessment,
            "ai_business_impact": self.ai_business_impact
        }

    @classmethod
    def from_dict(cls, data: dict) -> "Vulnerability":
        """Create from dictionary."""
        data = data.copy()
        if "severity" in data:
            data["severity"] = VulnerabilitySeverity(data["severity"])
        if "discovered_at" in data and isinstance(data["discovered_at"], str):
            data["discovered_at"] = datetime.fromisoformat(data["discovered_at"])
        return cls(**data)
